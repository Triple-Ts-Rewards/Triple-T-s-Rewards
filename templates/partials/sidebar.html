
<!-- Sidebar -->
<aside class="app-sidebar" id="sidebar">
  <ul class="sidebar-list">
        
        {# --- UNIVERSAL LINKS / NON-COLLAPSIBLE ITEMS --- #}
        
        {% if current_user.is_authenticated %}
            {# For Sponsors: Link directly to their own store preview #}
            {% if current_user.USER_TYPE == 'sponsor' %}
                <li>
                    <a href="{{ url_for('sponsor_bp.view_my_store') }}" class="sidebar-link {{ 'active' if 'view_my_store' in request.endpoint else '' }}">
                        My Points Store
                    </a>
                </li>
            {# For Drivers: Link to a new route that will automatically find a store #}
            {% elif current_user.USER_TYPE == 'driver' %}
                <li>
                    <a href="{{ url_for('driver_bp.redirect_to_store') }}" class="sidebar-link">
                        View Sponsor Stores
                    </a>
                </li>
            {% endif %}
        {% endif %}

        {# Example: About Page #}
        <li>
            <a href="{{ url_for('about_bp.view_about') }}" class="sidebar-link {{ 'active' if 'about_bp.view_about' in request.endpoint else '' }}">
                About Page
            </a>
        </li>


        {% if current_user.is_authenticated %}
            {% if current_user.USER_TYPE == 'administrator' %}
                <li>
                    <a href="{{ url_for('administrator_bp.dashboard') }}" class="sidebar-link {{ 'active' if request.endpoint == 'administrator_bp.dashboard' else '' }}">
                        Admin Dashboard
                    </a>
                </li>
            {% elif current_user.USER_TYPE == 'sponsor' %}
                <li>
                    <a href="{{ url_for('sponsor_bp.dashboard') }}" class="sidebar-link {{ 'active' if request.endpoint == 'sponsor_bp.dashboard' else '' }}">
                        Sponsor Dashboard
                    </a>
                </li>
            {% elif current_user.USER_TYPE == 'driver' %}
                <li>
                    <a href="{{ url_for('driver_bp.dashboard') }}" class="sidebar-link {{ 'active' if request.endpoint == 'driver_bp.dashboard' else '' }}">
                        Driver Dashboard
                    </a>
                </li>
            {% endif %}
        {% endif %}

        {# --- REMAINDER OF ROLE-SPECIFIC LINKS (AFTER DASHBOARDS) --- #}

        {# --- Administrator Links (Other than Dashboard) --- #}
        {% if current_user.is_authenticated and current_user.USER_TYPE == 'administrator' %}
            <li>
                {% set account_endpoints = ['administrator_bp.accounts', 'administrator_bp.add_user', 'administrator_bp.edit_user', 'administrator_bp.disabled_accounts', 'administrator_bp.locked_users', 'administrator_bp.unlock'] %}
                <a href="{{ url_for('administrator_bp.accounts') }}" class="sidebar-link {{ 'active' if request.endpoint in account_endpoints else '' }}">
                    Manage Accounts
                </a>
            </li>
            <li>
                <a href="{{ url_for('administrator_bp.audit_menu') }}" class="sidebar-link {{ 'active' if 'audit' in request.endpoint else '' }}">
                    Audit Log
                </a>
            </li>
        {% endif %}

        {# --- Sponsor Links (Other than Dashboard) --- #}
        {% if current_user.is_authenticated and current_user.USER_TYPE == 'sponsor' %}
            <li>
                {% set sponsor_driver_endpoints = ['sponsor_bp.list__sponsor_users', 'sponsor_bp.add_user', 'sponsor_bp.create_user'] %}
                <a href="{{ url_for('sponsor_bp.driver_management') }}" class="sidebar-link {{ 'active' if request.endpoint in sponsor_driver_endpoints else '' }}">
                    Manage Drivers
                </a>
            </li>
             <li>
                <a href="{{ url_for('sponsor_bp.review_driver_applications') }}" class="sidebar-link {{ 'active' if request.endpoint == 'sponsor_bp.review_driver_applications' else '' }}">
                    Review Applications
                </a>
            </li>
        {% endif %}

        {# --- Driver Links (Other than Dashboard) --- #}
        {% if current_user.is_authenticated and current_user.USER_TYPE == 'driver' %}
            <li>
                <a href="{{ url_for('driver_bp.point_history') }}" class="sidebar-link {{ 'active' if request.endpoint == 'driver_bp.point_history' else '' }}">
                    Point History
                </a>
            </li>
            <li>
                {% set driver_settings_endpoints = ['driver_bp.settings', 'driver_bp.update_info', 'driver_bp.addresses', 'driver_bp.address_form'] %}
                <a href="{{ url_for('driver_bp.settings') }}" class="sidebar-link {{ 'active' if request.endpoint in driver_settings_endpoints else '' }}">
                    Account Settings
                </a>
            </li>
        {% endif %}
  </ul>
</aside>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const toggle = document.querySelector(".sidebar-toggle");

  if (!toggle) return;

  // Create overlay if not already present
  let overlay = document.querySelector(".sidebar-overlay");
  if (!overlay) {
    overlay = document.createElement("div");
    overlay.className = "sidebar-overlay";
    document.body.appendChild(overlay);
  }

  // Toggle sidebar open/close when clicking hamburger
  toggle.addEventListener("click", function(e) {
    e.stopPropagation();
    document.body.classList.toggle("is-sidebar-open");
  });

  // Close when clicking overlay
  overlay.addEventListener("click", function() {
    document.body.classList.remove("is-sidebar-open");
  });

  // Close on ESC key
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape") {
      document.body.classList.remove("is-sidebar-open");
    }
  });
});
</script>