{% extends "base.html" %}
{% block content %}

  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h1>{{ title }}</h1>
    <a class="btn"
       href="{{ url_for('administrator_bp.export_audit_csv') }}{% if url_params_qs %}?{{ url_params_qs }}{% endif %}">
      ⬇︎ Download CSV
    </a>
  </div>

  {% include "partials/filter.html" with context %}

  {% if logs|length == 0 %}
    <p class="muted">No events yet.</p>
  {% else %}
    <table>
      <thead>
        <tr>
          <th style="width: 18%">Time (UTC)</th>
          <th style="width: 14%">Type</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for e in logs %}
          <tr>
            <td>{{ e.CREATED_AT.strftime('%Y-%m-%d %H:%M:%S') if e.CREATED_AT else '' }}</td>

            {% if title == "Login Activity" %}
              {% set status = (e.DETAILS or "").split(" ", 1)[0] %}
              {% set cls = status.lower() %}
              <td><span class="badge {{ cls }}">{{ status }}</span></td>
            {% else %}
              <td>{{ e.EVENT_TYPE }}</td>
            {% endif %}

            <td><code>{{ e.DETAILS or "" }}</code></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {# ✅ PAGINATION SECTION GOES HERE #}
  {% if pagination and pagination.pages > 1 %}
    {% macro page_href(n) -%}
      {{ base_url }}{% if url_params_qs %}?{{ url_params_qs }}&page={{ n }}{% else %}?page={{ n }}{% endif %}
    {%- endmacro %}

    <nav class="pager" aria-label="Pagination" style="margin-top:1rem; display:flex; gap:.4rem; flex-wrap:wrap;">
      <a class="page-btn {{ '' if pagination.has_prev else 'disabled' }}"
         href="{{ page_href(1) if pagination.has_prev else '#' }}">« First</a>

      <a class="page-btn {{ '' if pagination.has_prev else 'disabled' }}"
         href="{{ page_href(pagination.prev_num) if pagination.has_prev else '#' }}">‹ Prev</a>

      {% set start_p = 1 if pagination.page <= 3 else pagination.page - 2 %}
      {% set end_p = pagination.pages if pagination.page + 2 >= pagination.pages else pagination.page + 2 %}
      {% for p in range(start_p, end_p + 1) %}
        <a class="page-btn {{ 'active' if p == pagination.page else '' }}" href="{{ page_href(p) }}">{{ p }}</a>
      {% endfor %}

      <a class="page-btn {{ '' if pagination.has_next else 'disabled' }}"
         href="{{ page_href(pagination.next_num) if pagination.has_next else '#' }}">Next ›</a>

      <a class="page-btn {{ '' if pagination.has_next else 'disabled' }}"
         href="{{ page_href(pagination.pages) if pagination.has_next else '#' }}">Last »</a>
    </nav>

    <style>
      .page-btn { padding:.35rem .6rem; border:1px solid var(--border); border-radius:.35rem; text-decoration:none; }
      .page-btn.active { font-weight:700; }
      .page-btn.disabled { pointer-events:none; opacity:.5; }
    </style>
  {% endif %}

  <p style="margin-top:1rem;">
    <a class="btn btn-outline" href="{{ url_for('administrator_bp.audit_menu') }}">← Back to Audit Logs</a>
  </p>
{% endblock %}
