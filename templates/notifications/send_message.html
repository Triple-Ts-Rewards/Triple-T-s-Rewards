{% extends "base.html" %}
{% block content %}
  <div class="page-header">
    <h1>Send Message</h1>
    <p class="text-muted" style="margin:0;">Target a role, pick recipients, and send an announcement.</p>
  </div>

  <div class="card-elevated">
    <div class="card-header-accent">
      <h2>Audience</h2>
    </div>
    <div class="org-card-body">
      <form method="get" action="{{ url_for('notification_bp.send_message') }}" id="roleForm" class="dashboard-actions" style="max-width:320px;">
        <label style="width:100%;">
          <span class="text-muted" style="display:block; margin-bottom:.35rem;">Send to</span>
          <select name="role" onchange="this.form.submit()" class="input">
            <option value="all"           {{ 'selected' if role=='all' }}>All users</option>
            <option value="driver"        {{ 'selected' if role=='driver' }}>Drivers</option>
            <option value="sponsor"       {{ 'selected' if role=='sponsor' }}>Sponsors</option>
            <option value="administrator" {{ 'selected' if role=='administrator' }}>Administrators</option>
          </select>
        </label>
      </form>
    </div>
  </div>

  <div class="card-elevated">
    <div class="card-header-accent">
      <h2>Compose Message</h2>
    </div>
    <div class="org-card-body">
      <form method="post" action="{{ url_for('notification_bp.send_message') }}" style="display:grid; gap:1rem;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="role" value="{{ role }}">

        <label class="checkbox">
          <input type="checkbox" name="send_all" id="send_all"> Send to everyone in this role
        </label>

        <div id="pick-recipients" class="card-elevated" style="padding:1rem; max-height:280px; overflow:auto; box-shadow:none;">
          {% for u in users %}
            <label style="display:flex; justify-content:space-between; padding:.25rem 0; gap:0.5rem;">
              <span>
                <input type="checkbox" name="recipients" value="{{ u.USER_CODE }}">
                {{ u.USERNAME }}
              </span>
              <small class="text-muted">{{ u.USER_TYPE.name if u.USER_TYPE else '' }}</small>
            </label>
          {% else %}
            <em>No users in this group.</em>
          {% endfor %}
        </div>

        <div>
          <label for="message">Message</label>
          <textarea id="message" name="message" rows="4" class="input" required placeholder="Share an update"></textarea>
        </div>

        <button type="submit" class="btn btn-primary" style="justify-self:flex-start;">Send</button>
      </form>
    </div>
  </div>

  <script>
    const sendAll = document.getElementById("send_all");
    const pick = document.getElementById("pick-recipients");
    function togglePick() {
      const boxes = pick.querySelectorAll("input[type=checkbox]");
      pick.style.opacity = sendAll.checked ? 0.5 : 1;
      boxes.forEach(b => b.disabled = sendAll.checked);
    }
    if (sendAll && pick) {
      sendAll.addEventListener("change", togglePick);
      togglePick();
    }
  </script>
{% endblock %}
