
{% extends "base.html" %}
{% block styles %}
  {{ super() }}
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
{% endblock %}
{% block content %}
<main class="app-main-content container">
  <h1>Manage Driver Points</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-messages {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

{% block title %}Manage Driver Points{% endblock %}

    <section>
      <form id="filter-form" method="GET" action="{{ url_for('sponsor_bp.manage_points_page') }}" style="display:flex; flex-direction:column; gap:.5rem; margin-bottom:1rem;">
        <div style="display:flex; align-items:center; gap:.5rem;">
          <input type="text" name="search" placeholder="Search by username..." value="{{ request.args.get('search', '') }}" aria-label="Search by username" class="form-control" style="flex:1;">
          <button type="submit" class="btn btn-outline-secondary">Search</button>
          <button id="filter-toggle" type="button" class="btn btn-outline-secondary" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center;" title="Filter by status" aria-label="Filter by status">
            <i class="fa fa-filter"></i>
          </button>
        </div>

        <div id="status-filter" style="display:none; flex-wrap:wrap; gap:.5rem; background:#f7f7f7; padding:1rem; border-radius:6px;">
          <select name="status" class="form-control" style="padding:.5rem;">
            <option value="">All Drivers</option>
            <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
          </select>
          <button type="submit" class="btn btn-outline-secondary">Apply</button>
          <a href="{{ url_for('sponsor_bp.manage_points_page') }}" class="btn btn-outline-secondary">Reset</a>
        </div>
      </form>
    </section>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const toggle = document.getElementById('filter-toggle');
        const statusSection = document.getElementById('status-filter');
        toggle.addEventListener('click', () => {
          statusSection.style.display = statusSection.style.display === 'none' ? 'flex' : 'none';
        });
      });
    </script>

    <!-- ====== Driver Table ====== -->
    <section class="data-section">
      <table class="data-table">
        <thead>
            <tr>
                <th>Driver Username</th>
                <th>Current Points</th>
                <th style="width: 40%;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for assoc in associations %}
            <tr>
                <td>{{ assoc.driver.user.USERNAME }}</td>
                <td>{{ assoc.points }}</td>
                <td>
                    <form action="{{ url_for('sponsor_bp.manage_points', driver_id=assoc.driver.DRIVER_ID) }}" method="post" class="form-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group mb-2 mr-sm-2">
                            <input type="number" name="points" class="form-control" placeholder="Points" required min="1">
                        </div>
                        <div class="form-group mb-2 mr-sm-2">
                            <select name="action" class="form-control">
                                <option value="award">Award</option>
                                <option value="remove">Remove</option>
                            </select>
                        </div>
                        <div class="form-group mb-2 mr-sm-2">
                            <input type="text" name="reason" class="form-control" placeholder="Reason (if removing)">
                        </div>
                        <button type="submit" class="btn btn-primary mb-2">Submit</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>There are no drivers currently associated with your organization.</p>
    {% endif %}
</div>
{% endblock %}