{% extends "base.html" %}

{% block title %}Manage Driver Points{% endblock %}

{% block styles %}
{{ super() }}
<link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>
{% endblock %}

{% block content %}
        <div class="page-header">
                <h1>Manage Driver Points</h1>
                <p class="text-muted" style="margin: 0;">Search drivers, award or remove points, and keep balances up to date.</p>
        </div>

        <div class="card-elevated">
                <div class="card-header-accent">
                        <h2>Filters</h2>
                </div>
                <div class="org-card-body">
                        <form id="filter-form" method="GET" action="{{ url_for('sponsor_bp.manage_points_page') }}" style="display:flex; flex-direction:column; gap:1rem;">
                                <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap;">
                                        <input type="text" name="search" placeholder="Search by username..." value="{{ request.args.get('search', '') }}" aria-label="Search by username" class="input" style="flex:1; min-width:220px;">
                                        <button type="submit" class="btn btn-primary">Search</button>
                                        <button id="filter-toggle" type="button" class="btn btn-outline" style="width:44px; height:44px; display:flex; align-items:center; justify-content:center;" title="Filter options" aria-label="Filter options">
                                                <i class="fa fa-filter"></i>
                                        </button>
                                </div>

                                <div id="status-filter" style="display:none; flex-wrap:wrap; gap:.5rem; background: var(--surface); padding:1rem; border-radius:10px; border:1px solid var(--border);">
                                        <select name="status" class="input" style="min-width:200px;">
                                                <option value="">All Drivers</option>
                                                <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Active</option>
                                                <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
                                        </select>
                                        <button type="submit" class="btn btn-primary">Apply</button>
                                        <a href="{{ url_for('sponsor_bp.manage_points_page') }}" class="btn btn-outline">Reset</a>
                                </div>
                        </form>
                </div>
        </div>

        <div class="card-elevated">
                <div class="card-header-accent">
                        <h2>Overview</h2>
                </div>
                <div class="org-card-body" style="display:flex; gap:1.5rem; flex-wrap:wrap;">
                        <div class="metric-card">
                                <i class="fa-solid fa-star"></i>
                                <div>
                                        <p class="metric-label">Total Points</p>
                                        <p class="metric-value">{{ total_points }}</p>
                                </div>
                        </div>
                        <div class="metric-card">
                                <i class="fa-solid fa-chart-line"></i>
                                <div>
                                        <p class="metric-label">Average Points / Driver</p>
                                        <p class="metric-value">{{ avg_points }}</p>
                                </div>
                        </div>
                        <div class="metric-card">
                                <i class="fa-solid fa-calender-week"></i>
                                <div>
                                        <p class="metric-label">Points Given This Week</p>
                                        <p class="metric-value">{{ points_given_this_week }}</p>
                                </div>
                        </div>
                </div>

        {% if drivers %}
        <div class="card-elevated">
                <div class="card-header-accent">
                        <h2>Drivers</h2>
                </div>
                <div class="org-card-body">
                        <div class="table-responsive">
                                <table>
                                        <thead>
                                                <tr>
                                                        <th>Driver Name</th>
                                                        <th>
                                                                <a 
                                                                        href="{{ url_for('sponsor_bp.manage_points_page',
                                                                                                                                                search=request.args.get('search', ''),
                                                                                                                                                status=request.args.get('status', ''),
                                                                                                                                                sort='username_desc' if request.args.get('sort') != 'username_desc' else 'username_asc') }}"
                                                                        class="link-muted">
                                                                        Username
                                                                        {% if request.args.get('sort') == 'username_desc' %}
                                                                                ‚ñ≤
                                                                        {% elif request.args.get('sort') == 'username_asc' %}
                                                                                ‚ñº
                                                                        {% else %}
                                                                                <span style="opacity:0.6;">‚áÖ</span>
                                                                        {% endif %}
                                                                </a>
                                                        </th>
                                                        <th>Email</th>
                                                        <th>
                                                                <a 
                                                                        href="{{ url_for('sponsor_bp.manage_points_page',
                                                                                                                                                search=request.args.get('search', ''),
                                                                                                                                                status=request.args.get('status', ''),
                                                                                                                                                sort='points_desc' if request.args.get('sort') != 'points_desc' else 'points_asc') }}"
                                                                        class="link-muted">
                                                                        Current Points
                                                                        {% if request.args.get('sort') == 'points_desc' %}
                                                                                ‚ñ≤
                                                                        {% elif request.args.get('sort') == 'points_asc' %}
                                                                                ‚ñº
                                                                        {% else %}
                                                                                <span style="opacity:0.6;">‚áÖ</span>
                                                                        {% endif %}
                                                                </a>
                                                        </th>
                                                        <th>Action</th>
                                                </tr>
                                        </thead>
                                        <tbody>
                                                {% for driver in drivers %}
                                                <tr>
                                                        <td>{{ driver.user.FNAME }} {{ driver.user.LNAME }}</td>
                                                        <td>{{ driver.user.USERNAME }}</td>
                                                        <td>{{ driver.user.EMAIL }}</td>
                                                        <td>
                                                                <span class="badge-small badge-preview-base current-points-badge" data-current-points="{{ driver.points }}">{{ driver.points }}</span>
                                                        </td>
                                                        <td>
                                                                <form action="{{ url_for('sponsor_bp.manage_points', driver_id=driver.user.USER_CODE) }}" method="post" class="point-update-form" style="display:flex; flex-wrap:wrap; gap:.5rem; align-items:flex-end;">
                                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                                        <input type="hidden" name="search_query" value="{{ search_query or '' }}">
                                                                        <input type="hidden" name="status_filter" value="{{ status_filter or '' }}">
                                                                        <input type="hidden" name="current_sort" value="{{ current_sort or 'username_asc' }}">

                                                                        <div class="form-group" style="min-width:110px;">
                                                                                <label for="points-{{ loop.index }}">Points</label>
                                                                                <input id="points-{{ loop.index }}" type="number" name="points" placeholder="Points" required min="1">
                                                                        </div>
                                                                        <div class="form-group" style="min-width:140px;">
                                                                                <label for="action-{{ loop.index }}">Action</label>
                                                                                <select id="action-{{ loop.index }}" name="action">
                                                                                        <option value="award">Award</option>
                                                                                        <option value="remove">Remove</option>
                                                                                </select>
                                                                        </div>
                                                                        <div class="form-group" style="flex:1; min-width:220px;">
                                                                                <label for="reason-{{ loop.index }}">Reason (optional)</label>
                                                                                <input id="reason-{{ loop.index }}" type="text" name="reason" placeholder="Reason if removing">
                                                                        </div>
                                                                        <button type="submit" class="btn btn-primary">Submit</button>
                                                                </form>
                                                        </td>
                                                </tr>
                                                {% endfor %}
                                        </tbody>
                                </table>
                        </div>
                </div>
        </div>
        {% else %}
        <div class="empty-state">
                <div class="empty-state-icon">üöö</div>
                <p class="empty-state-heading">There are no drivers currently associated with your organization.</p>
        </div>
        {% endif %}

        <div class="card-elevated">
                <div class="card-header-accent">
                        <h2>Navigation</h2>
                </div>
                <div class="org-card-body" style="text-align:center;">
                        <a class="btn btn-outline" href="{{ url_for('sponsor_bp.dashboard') }}">‚Üê Back to Sponsor Dashboard</a>
                </div>
        </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
        const forms = document.querySelectorAll('.point-update-form');
        const toggle = document.getElementById('filter-toggle');
        const statusSection = document.getElementById('status-filter');

        if (toggle && statusSection) {
                statusSection.style.display = 'none';
                toggle.addEventListener('click', () => {
                        const isHidden = statusSection.style.display === 'none';
                        statusSection.style.display = isHidden ? 'flex' : 'none';
                });
        }

        forms.forEach(form => {
                const pointsInput = form.querySelector('input[name="points"]');
                const actionSelect = form.querySelector('select[name="action"]');
                const pointsBadge = form.closest('tr').querySelector('.current-points-badge');

                if (!pointsInput || !actionSelect || !pointsBadge) {
                        return;
                }

                const originalPoints = parseInt(pointsBadge.dataset.currentPoints, 10);

                function updatePointsPreview() {
                        const pointsToChange = parseInt(pointsInput.value, 10);
                        const action = actionSelect.value;

                        if (isNaN(pointsToChange) || pointsToChange <= 0) {
                                pointsBadge.textContent = originalPoints;
                                pointsBadge.classList.remove('badge-preview-award', 'badge-preview-remove');
                                pointsBadge.classList.add('badge-preview-base');
                                return;
                        }

                        let newTotal;
                        if (action === 'award') {
                                newTotal = originalPoints + pointsToChange;
                                pointsBadge.classList.remove('badge-preview-base', 'badge-preview-remove');
                                pointsBadge.classList.add('badge-preview-award');
                        } else {
                                newTotal = originalPoints - pointsToChange;
                                pointsBadge.classList.remove('badge-preview-base', 'badge-preview-award');
                                pointsBadge.classList.add('badge-preview-remove');
                        }

                        pointsBadge.textContent = `${originalPoints} ‚Üí ${newTotal}`;
                }

                pointsInput.addEventListener('input', updatePointsPreview);
                actionSelect.addEventListener('change', updatePointsPreview);
        });
});
</script>
{% endblock %}