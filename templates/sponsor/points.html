{% extends "base.html" %}

{% block title %}Manage Driver Points{% endblock %}

{% block styles %}
{{ super() }}
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Manage Driver Points</h2>
    <form id="filter-form" method="GET" action="{{ url_for('sponsor_bp.manage_points_page') }}" style="display:flex; flex-direction:column; gap:.5rem; margin-bottom:1rem;">
      <div style="display:flex; align-items:center; gap:.5rem;">
        <input type="text" name="search" placeholder="Search by username..." value="{{ request.args.get('search', '') }}" aria-label="Search by username" class="form-control" style="flex:1;">
        <button type="submit" class="btn btn-outline-secondary">Search</button>
        <button id="filter-toggle" type="button" class="btn btn-outline-secondary" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center;" title="Filter options" aria-label="Filter options">
          <i class="fa fa-filter"></i>
        </button>
      </div>

      <div id="status-filter" style="display:none; flex-wrap:wrap; gap:.5rem; background:#f7f7f7; padding:1rem; border-radius:6px;">
        <select name="status" class="form-control" style="padding:.5rem;">
          <option value="">All Drivers</option>
          <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Active</option>
          <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
        </select>
        <button type="submit" class="btn btn-outline-secondary">Apply</button>
        <a href="{{ url_for('sponsor_bp.manage_points_page') }}" class="btn btn-outline-secondary">Reset</a>
      </div>
    </form>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const toggle = document.getElementById('filter-toggle');
        const statusSection = document.getElementById('status-filter');
        toggle.addEventListener('click', () => {
          statusSection.style.display = statusSection.style.display === 'none' ? 'flex' : 'none';
        });
      });
    </script>

    <div class="mb-4" style="display:flex; gap:2rem; justify-content:flex-start; align-items:center;">
      <div style="background:#474B4F; padding:1rem 2rem; border-radius:8px; font-size:1.3rem; font-weight:600; color:#86C232; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
          <i class="fa-solid fa-star" style="color:#86C232;"></i> 
          Total Points: <span style="color:#ffffff;">{{ total_points }}</span>
      </div>
      <div style="background:#474B4F; padding:1rem 2rem; border-radius:8px; font-size:1.3rem; font-weight:600; color:#86C232; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
          <i class="fa-solid fa-chart-line" style="color:#86C232;"></i> 
          Average Points per Driver: <span style="color:#ffffff;">{{ avg_points }}</span>
      </div>
    </div>

    {% if drivers %}
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Driver Name</th>
                <th style="cursor:pointer;">
                  <a 
                    href="{{ url_for('sponsor_bp.manage_points_page',
                                      search=request.args.get('search', ''),
                                      status=request.args.get('status', ''),
                                      sort='username_desc' if request.args.get('sort') != 'username_desc' else 'username_asc') }}"
                    style="color:#86C232; text-decoration:none; font-weight:600;">
                    Username
                    {% if request.args.get('sort') == 'username_desc' %}
                      ▲
                    {% elif request.args.get('sort') == 'username_asc' %}
                      ▼
                    {% else %}
                      <i class="fa-solid fa-sort" style="color:#ccc; margin-left:4px;"></i>
                    {% endif %}
                  </a>
                </th>
                <th>Email</th>
                <th style="cursor:pointer;">
                  <a 
                    href="{{ url_for('sponsor_bp.manage_points_page',
                                      search=request.args.get('search', ''),
                                      status=request.args.get('status', ''),
                                      sort='points_desc' if request.args.get('sort') != 'points_desc' else 'points_asc') }}"
                    style="color:#86C232; text-decoration:none; font-weight:600;">
                    Current Points
                    {% if request.args.get('sort') == 'points_desc' %}
                      ▲
                    {% elif request.args.get('sort') == 'points_asc' %}
                      ▼
                    {% else %}
                      <i class="fa-solid fa-sort" style="color:#ccc; margin-left:4px;"></i>
                    {% endif %}
                  </a>
                </th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for driver in drivers %}
            <tr>
                <td>{{ driver.user.FNAME }} {{ driver.user.LNAME }}</td>
                <td>{{ driver.user.USERNAME }}</td>
                <td>{{ driver.user.EMAIL }}</td>
                <td><span class="badge bg-primary current-points-badge" data-current-points="{{ driver.points }}">{{ driver.points }}</span></td>
                <td>
                  <form action="{{ url_for('sponsor_bp.manage_points', driver_id=driver.user.USER_CODE) }}" method="post" class="form-inline point-update-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <input type="hidden" name="search_query" value="{{ search_query or '' }}">
                        <input type="hidden" name="status_filter" value="{{ status_filter or '' }}">
                        <input type="hidden" name="current_sort" value="{{ current_sort or 'username_asc' }}">

                        <div class="form-group mb-2 mr-sm-2">
                            <input type="number" name="points" class="form-control" placeholder="Points" required min="1">
                        </div>
                        <div class="form-group mb-2 mr-sm-2">
                            <select name="action" class="form-control">
                                <option value="award">Award</option>
                                <option value="remove">Remove</option>
                            </select>
                        </div>
                        <div class="form-group mb-2 mr-sm-2">
                            <input type="text" name="reason" class="form-control" placeholder="Reason (if removing)">
                        </div>
                        <button type="submit" class="btn btn-primary mb-2">Submit</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>There are no drivers currently associated with your organization.</p>
    {% endif %}
</div>
<p style="margin-top: 1.5rem; text-align: center;">
  <a class="btn btn-outline" href="{{ url_for('sponsor_bp.dashboard') }}">← Back to Sponsor Dashboard</a>
</p>
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Find all point update forms
    const forms = document.querySelectorAll('.point-update-form');

    forms.forEach(form => {
        const pointsInput = form.querySelector('input[name="points"]');
        const actionSelect = form.querySelector('select[name="action"]');
        // Find the badge associated with this form's row by traversing up to the <tr>
        const pointsBadge = form.closest('tr').querySelector('.current-points-badge');
        
        if (!pointsInput || !actionSelect || !pointsBadge) {
            console.warn("Could not find all elements for point preview in a form.");
            return; // Skip if form is incomplete
        }

        // Get the original points value stored in the data attribute
        const originalPoints = parseInt(pointsBadge.dataset.currentPoints, 10);

        function updatePointsPreview() {
            const pointsToChange = parseInt(pointsInput.value, 10);
            const action = actionSelect.value;

            if (isNaN(pointsToChange) || pointsToChange <= 0) {
                // Reset to original if input is invalid or empty
                pointsBadge.textContent = originalPoints;
                pointsBadge.classList.remove('badge-preview-award', 'badge-preview-remove');
                pointsBadge.classList.add('bg-primary'); // Ensure it's back to the default color
                return;
            }

            let newTotal;
            if (action === 'award') {
                newTotal = originalPoints + pointsToChange;
                // Apply preview styles
                pointsBadge.classList.remove('bg-primary', 'badge-preview-remove');
                pointsBadge.classList.add('badge-preview-award');
            } else { // action === 'remove'
                newTotal = originalPoints - pointsToChange;
                // Apply preview styles
                pointsBadge.classList.remove('bg-primary', 'badge-preview-award');
                pointsBadge.classList.add('badge-preview-remove');
            }

            // Update the text to show the change
            pointsBadge.textContent = `${originalPoints} → ${newTotal}`;
        }

        // Add event listeners to update the preview on input or selection change
        pointsInput.addEventListener('input', updatePointsPreview);
        actionSelect.addEventListener('change', updatePointsPreview);
    });
});
</script>

<style>
    .badge-preview-award {
        background-color: #28a745 !important; /* Green */
        color: white;
        font-weight: bold;
    }
    .badge-preview-remove {
        background-color: #dc3545 !important; /* Red */
        color: white;
        font-weight: bold;
    }
</style>
{% endblock %}
{% endblock %}